AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy EKS Cluster
#----------------------------------------------
Parameters:
  Environment:
    Type: String
    AllowedPattern: "[a-zA-Z0-9=-@+?[?]?<?>._]*"
    ConstraintDescription: Can contain only ASCII characters.
    Description: (required) Environment name
  K8sVersion:
    Type: String
    Description: (Optional) Select the Kubernetes version to install.
    Default: "1.13"
    AllowedValues:
      - "1.13"
      - "1.12"
      - "1.11"
#----------------------------------------------
Resources:
  # K8s Manager(User)
  K8sHighAuthorityPolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: !Sub "${Environment}-K8sHighAuthorityPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "AllowEKSCluster"
            Effect: Allow
            Action:
              - eks:*
            Resource: "*"
          - Sid: "AllowPassRoleForCreateClusters"
            Effect: Allow
            Action:
              - iam:GetRole
              - iam:PassRole
            Resource: "*"
          - Sid: "OnlyThisPoCEnvironment"
            Effect: Allow
            Action:
              - cloudformation:Describe*
              - cloudformation:List*
            Resource: "*"
      Roles:
        - Fn::ImportValue: !Sub ${Environment}-Iam-HighAuthorityInstanceRoleName
  #--------
  K8sManagerPolicy:
    Type: AWS::IAM::Policy
    Properties: 
      PolicyName: !Sub "${Environment}-K8sManagerPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "AllowUpdateClusterVersionOnly"
            Effect: Allow
            Action:
              - eks:UpdateClusterVersion
              - eks:Describe*
              - eks:List*
            Resource: "*"
      Roles:
        - Fn::ImportValue: !Sub ${Environment}-Iam-ManagerInstanceRoleName


#Outputs:
#  #---------------- EC2 Instance
#  EksClusterId:
#    Description: Eks Cluster ID
#    Value: !Ref EksCluster
#    Export:
#      Name: !Sub ${AWS::StackName}-EksClusterId